---

- name: Install Docker
  hosts: jenkins
  become: true
  become_user: root
  tasks:
    - name: Update and upgrade packages
      apt:
        upgrade: yes
        update_cache: yes

    - name: Install docker
      apt:
        pkg:
          - docker.io
          - docker-compose

    - name: Show ansible_user
      debug: var=ansible_user

    - name: usermod -aG docker
      user:
        name: "{{ ansible_user }}"
        groups: docker
        append: yes

    - name: reset ssh connection
      meta: reset_connection


- name: Start Jenkins
  hosts: jenkins
  tasks:
    - name: Show home directory
      debug: var=ansible_env.HOME

    - name: Include jenkins variables
      include_vars: jenkins.yml

    - name: Create jenkins volume folder
      file:
        path: "{{ jenkins.directory }}"
        state: directory
        owner: "{{ ansible_user }}"
        recurse: yes

    - name: Copy jenkins home
      copy:
        src: "keys/"
        dest: "{{ jenkins.directory }}/.ssh"

    - name: Create a network
      docker_network:
        name: jenkins-networks

    - name: Run Jenkins
      docker_container:
        name: "{{ jenkins['name'] }}"
        image: "{{ jenkins['image'] }}"
        ports: "{{ jenkins['ports'] }}"
        volumes: "{{ jenkins['volumes'] }}"
        restart_policy: always
        pull: yes
        recreate: yes
        networks:
          - name: jenkins-networks

    - name: Run Jenkins SSH Agent
      docker_container:
        name: ssh-agent
        image: jenkins/ssh-agent
        restart_policy: always
        recreate: yes
        networks:
          - name: jenkins-networks
        env:
          JENKINS_AGENT_SSH_PUBKEY: ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDdekyUWSS9ZV7p+zvcKgsbQKHDiDXRWt8V//KIV3OvVKLK/5LD4gDCiB9FwvEPKw4bhmcEyeO1mwTQftgAYUed3BOK1UpMu82IsIz/susNQTsIyOx+DbMAM9dlr4hq6MB8SvyWjz5AVw+SY2shqF+n3dG8Anhpzzv73jRg08IV/MTZzLH8kKdZK5TRkCu3TljDu1Lxq0/etFSCH/sR6OgX3wWIci7/YYRL5ZiFs2KRVlie4wZtJed5ChDw/RUvfuBrQBYXJaYGGiaal0N+LgGXYJH7+cVLbXsiNARZXbrG+II+DQe+KOdgPbRslJIX3tEuT0IkoC3b57tc8dbtb82qTppLWGSX3sIu9cydfIivqCjOjLFFvTknOrdY0toNOmDFtpxoLp4HPPWYTyVUhfVwv0wJKtuzsjD99P1FpLLXgz3DsCo89Za4tYs0b11U36JhNcsh7GxcdbYXevOODfys/KUgFAJW60eaF1M+y2KlK4sdA1vurcHIgKIIc43rRsU= changningt@ctsai-0130.local

- name: Setup Jenkins backup
  hosts: jenkins
  tasks:
    - name: Get the backup script
      git:
        repo: 'https://github.com/sue445/jenkins-backup-script.git'
        dest: "{{ ansible_env.HOME }}/jenkins-backup-script"

    - name: Create jenkins volume folder
      file:
        path: "{{ ansible_env.HOME }}/backup"
        state: directory
        owner: "{{ ansible_user }}"

    - name: Setup cron job
      cron:
        name: "Run Jenkins backup cron"
        minute: 0
        job: "{{ ansible_env.HOME }}/jenkins-backup-script/jenkins-backup.sh {{ jenkins.directory }} {{ ansible_env.HOME }}/backup/backup_`date +'%Y%m%d%H%M%S'`.tar.gz"

    - name: Setup old backup deletation
      cron:
        name: "Run Jenkins backup deletation"
        minute: 15
        job: "find {{ ansible_env.HOME }}/backup/backup_* -mmin +15 -delete"
